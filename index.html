<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Админ — Заказы</title>
  <style>
    #login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #000;
    }
    
    .login-container {
      background: #333;
      border-radius: 20px;
      padding: 30px;
      width: 90%;
      max-width: 400px;
      border: 1px solid rgba(255,255,255,.1);
    }
    
    .login-title {
      color: #fff;
      text-align: center;
      margin-bottom: 30px;
      font-size: 24px;
    }
    
    .login-input {
      width: 100%;
      padding: 14px;
      margin-bottom: 20px;
      border: 2px solid rgba(255,255,255,.2);
      border-radius: 10px;
      background: #171717;
      color: #fff;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    .login-button {
      width: 100%;
      padding: 14px;
      background: #fff;
      color: #000;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: opacity 0.2s;
      margin-bottom: 15px;
    }
    
    .login-button:hover {
      opacity: 0.9;
    }
    
    .error-message {
      color: #ff6b6b;
      text-align: center;
      margin: 15px 0;
      font-size: 14px;
      min-height: 20px;
    }
    
    .success-message {
      color: #4CAF50;
      text-align: center;
      margin: 15px 0;
      font-size: 14px;
    }
    
    body{ font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; margin:0; background:#000; color:#fff; }
    .w{ max-width:1100px; margin:0 auto; padding:12px; }
    .card{ background:#333333; border:1px solid #e8e8e8; border-radius:24px; padding:16px; }
    h1{ margin:0 0 16px; font-size:22px; color:#fff; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    input{ padding:14px; border:3px solid rgba(255,255,255,.16); border-radius:30px; font-size:16px; outline:none; background:#171717; color:#fff; width:100%; box-sizing:border-box; }
    button{ cursor:pointer; padding:14px 18px; border-radius:30px; border:3px solid rgba(255,255,255,.22); background:#171717; color:#fff; font-weight:800; font-size:16px; transition: transform .04s ease, filter .15s ease; width:100%; }
    button:hover{ filter:brightness(1.05); }
    button:active{ transform: translateY(1px); }
    .btnP{ background:#171717; color:#fff; border-color:#171717; }

    .desktop-table{ width:100%; border-collapse:collapse; margin-top:10px; }
    .desktop-table th,
    .desktop-table td{ text-align:left; padding:12px 8px; border-bottom:1px solid rgba(255,255,255,.10); font-size:14px; vertical-align:top; color:#fff; }
    .desktop-table th{ font-size:12px; color:rgba(255,255,255,.65); }

    .mobile-cards { display: none; margin-top: 20px; }
    .order-card { background: #171717; border-radius: 20px; padding: 18px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,.1); }
    .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
    .order-status { display:inline-flex; padding:6px 12px; border-radius:999px; border:1px solid #eee; background:#333; font-size:13px; font-weight:600; }
    .order-id { font-size: 12px; color: rgba(255,255,255,.5); margin-top: 4px; }
    .order-field { margin-bottom: 16px; }
    .field-label { font-size: 12px; color: rgba(255,255,255,.6); margin-bottom: 4px; display: block; }
    .field-value { font-size: 16px; color: #fff; }
    .field-value.muted { color: rgba(255,255,255,.7); font-size: 14px; }
    .status-controls { margin-top: 20px; }
    .status-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 12px; }
    .status-btn { padding: 12px; border-radius: 20px; border: 2px solid rgba(255,255,255,.2); background: #333; color: rgba(255,255,255,.8); font-size: 14px; font-weight: 600; text-align: center; }
    .status-btn.active { background: #fff; color: #000; border-color: #fff; font-weight: 700; }
    .status-updated { font-size: 12px; color: rgba(255,255,255,.5); margin-top: 12px; text-align: center; }

    .pill{ display:inline-flex; padding:6px 10px; border-radius:999px; border:1px solid #eee; background:#171717; font-size:12px; }
    .muted{ color:#777; }
    .btns{ display:flex; gap:6px; flex-wrap:wrap; }
    .steps{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .step{ padding:10px 14px; border-radius:30px; border:1px solid rgba(255,255,255,.12); background:#171717; font-size:14px; font-weight:800; color:rgba(255,255,255,.85); min-width:150px; text-align:center; }
    .step.a{ background:#ffffff; border-color:#ffffff; color:#171717; box-shadow:0 10px 24px rgba(0,0,0,.25); }
    .step.white{ background:#171717; border-color:#171717; color:#fff; box-shadow:none; font-size:14px; font-weight: 800; }
    .step.active { background:#171717; color:#fff; border-color:#fff; }

    @media (max-width: 768px) {
      .w { padding: 10px; }
      .card { border-radius: 20px; padding: 16px; }
      h1 { font-size: 20px; margin-bottom: 20px; }
      
      .desktop-table { display: none; }
      .mobile-cards { display: block; }
      
      .row { flex-direction: column; }
      input { width: 100%; }
      button { width: 100%; }
    }

    @media (min-width: 769px) {
      .mobile-cards { display: none; }
      .desktop-table { display: table; }
      
      .row {
        flex-direction: row;
        align-items: center;
      }
      input {
        width: auto;
        flex: 0 0 auto;
      }
      #load {
        width: auto;
      }
    }
    
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .admin-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logout-btn {
      background: #d32f2f;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .logout-btn:hover {
      background: #b71c1c;
    }
  </style>
</head>
<body>
  <div id="login-screen">
    <div class="login-container">
      <h1 class="login-title">Вход в админ-панель</h1>
      
      <div id="login-form">
        <input type="email" id="email-input" class="login-input" placeholder="Email администратора" autocomplete="off">
        <input type="password" id="password-input" class="login-input" placeholder="Пароль" autocomplete="off">
        
        <button id="login-button" class="login-button">Войти</button>
        
        <div id="login-error" class="error-message"></div>
        <div id="login-success" class="success-message"></div>
      </div>
    </div>
  </div>

  <div id="main-content" style="display: none;">
    <div class="w">
      <div class="card">
        <div class="admin-header">
          <h1>Админ: последние заказы</h1>
          <div class="admin-info">
            <span id="admin-email" class="muted"></span>
            <button id="logout-button" class="logout-btn">Выйти</button>
          </div>
        </div>
        
        <div class="row">
          <input id="days" type="number" min="1" value="1" placeholder="Количество дней" />
          <button id="load" class="btnP">Загрузить</button>
          <span id="msg" class="muted"></span>
        </div>

        <div id="out"></div>
      </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyATe76wcuLXsTuJifwFSuALB_NyEO4JE4Y",
    authDomain: "auth-6b667.firebaseapp.com",
    projectId: "auth-6b667",
    storageBucket: "auth-6b667.firebasestorage.app",
    messagingSenderId: "619451894826",
    appId: "1:619451894826:web:9a8eb7489b40f6b9974753"
};

let firebaseApp;
let firebaseAuth;

try {
  firebaseApp = firebase.initializeApp(firebaseConfig);
  firebaseAuth = firebaseApp.auth();
} catch (error) {
  document.getElementById('login-error').textContent = 'Ошибка конфигурации. Пожалуйста, проверьте настройки Firebase.';
}

async function login(email, password) {
  const errorElement = document.getElementById('login-error');
  const successElement = document.getElementById('login-success');
  
  errorElement.textContent = '';
  successElement.textContent = '';
  
  if (!email || !password) {
    errorElement.textContent = 'Заполните все поля';
    return;
  }
  
  try {
    const userCredential = await firebaseAuth.signInWithEmailAndPassword(email, password);
    showAdminPanel(userCredential.user);
    
  } catch (error) {
    switch (error.code) {
      case 'auth/invalid-email':
        errorElement.textContent = 'Неверный формат email';
        break;
      case 'auth/user-disabled':
        errorElement.textContent = 'Аккаунт отключен';
        break;
      case 'auth/user-not-found':
      case 'auth/wrong-password':
        errorElement.textContent = 'Неверный email или пароль';
        break;
      case 'auth/too-many-requests':
        errorElement.textContent = 'Слишком много попыток. Попробуйте позже';
        break;
      default:
        errorElement.textContent = 'Ошибка входа. Попробуйте снова';
    }
  }
}

async function logout() {
  try {
    await firebaseAuth.signOut();
    showLoginScreen();
  } catch (error) {
    console.error('Ошибка выхода:', error);
  }
}

function showLoginScreen() {
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('main-content').style.display = 'none';
  document.getElementById('email-input').value = '';
  document.getElementById('password-input').value = '';
  document.getElementById('login-error').textContent = '';
  document.getElementById('login-success').textContent = '';
}

function showAdminPanel(user) {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('main-content').style.display = 'block';
  document.getElementById('admin-email').textContent = user.email;
  initializeAdminPanel();
}

function initializeAdminPanel() {
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwgz9GiNHHlBDh0S-IIF-iLPEXyFcPt8x4-Vy6mnADDMpe77SPvJa6WwUs_YAWaYjfw/exec";
  const ADMIN_TOKEN = "7234dewqu4748";

  const out = document.getElementById('out');
  const msg = document.getElementById('msg');
  const days = document.getElementById('days');
  const loadBtn = document.getElementById('load');

  function esc(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;"); }
  function fmtDate(iso){ if(!iso) return '—'; try{ const d=new Date(iso); if(isNaN(d.getTime())) return iso; return d.toLocaleString(); }catch(e){ return iso; } }

  function statusLabel(st){
    st=(st||'').toLowerCase();
    if(st==='processing') return 'В обработке';
    if(st==='accepted') return 'Принят';
    if(st==='preparing') return 'Готовится';
    if(st==='courier') return 'У курьера';
    if(st==='delivered') return 'Доставлен';
    return 'В обработке';
  }

  function jsonp(params){
    return new Promise((resolve,reject)=>{
      const cb="adcb_"+Math.random().toString(36).slice(2);
      params.callback=cb;
      const url = SCRIPT_URL + "?" + new URLSearchParams(params).toString();
      const sc=document.createElement('script');
      sc.src=url; sc.async=true;
      const timer=setTimeout(()=>{ cleanup(); reject(new Error('timeout')); }, 12000);
      function cleanup(){ clearTimeout(timer); sc.remove(); try{ delete window[cb]; }catch(e){ window[cb]=undefined; } }
      window[cb]=(data)=>{ cleanup(); resolve(data); };
      sc.onerror=()=>{ cleanup(); reject(new Error('network')); };
      document.body.appendChild(sc);
    });
  }

  async function setStatus(rowId, status){
    msg.textContent = 'Обновляем статус…';
    try{
      const r = await jsonp({ action:'setStatus', token:ADMIN_TOKEN, rowId:String(rowId), status });
      if(!r || !r.ok) throw new Error((r && r.error) || 'error');
      msg.textContent = 'Готово ✅';
      await load();
    }catch(e){
      msg.textContent = 'Ошибка: ' + (e.message || e);
    }
  }

  function render(items){
    if(!items.length){
      out.innerHTML = `<div class="muted" style="margin-top:12px; text-align:center;">Нет заказов за выбранный период.</div>`;
      return;
    }

    const desktopRows = items.map(it=>{
      return `
        <tr>
          <td>
            <div class="pill">${esc(statusLabel(it.status))}</div><br/>
            <span class="muted">${esc(fmtDate(it.ts))}</span><br/>
            <span class="muted">rowId: ${esc(it.rowId)}</span>
          </td>
          <td>
            <b>${esc(it.name||'—')}</b><br/>
            ${esc(it.phone||'—')}<br/>
            <span class="muted">orderid: ${esc(it.orderid||'—')}</span>
          </td>
          <td>${esc(it.products||'—')}</td>
          <td>${esc(it.address||'—')}</td>
          <td>
            <b>${esc(it.price||'—')}</b>
          </td>
          <td>
            <div class="btns">
              <button class="step ${it.status === 'accepted' ? 'active' : ''}" onclick="window.__set(${it.rowId},'accepted')">Принят</button>
              <button class="step ${it.status === 'preparing' ? 'active' : ''}" onclick="window.__set(${it.rowId},'preparing')">Готовится</button>
              <button class="step ${it.status === 'courier' ? 'active' : ''}" onclick="window.__set(${it.rowId},'courier')">У курьера</button>
              <button class="step ${it.status === 'delivered' ? 'active' : ''}" onclick="window.__set(${it.rowId},'delivered')">Доставлен</button>
            </div>
            <div class="muted" style="margin-top:6px;">Обновлено: ${esc(fmtDate(it.statusUpdated))}</div>
          </td>
        </tr>
      `;
    }).join('');

    const mobileCards = items.map(it=>{
      const statusButtons = `
        <div class="status-buttons">
          <button class="status-btn ${it.status === 'accepted' ? 'active' : ''}" onclick="window.__set(${it.rowId},'accepted')">Принят</button>
          <button class="status-btn ${it.status === 'preparing' ? 'active' : ''}" onclick="window.__set(${it.rowId},'preparing')">Готовится</button>
          <button class="status-btn ${it.status === 'courier' ? 'active' : ''}" onclick="window.__set(${it.rowId},'courier')">У курьера</button>
          <button class="status-btn ${it.status === 'delivered' ? 'active' : ''}" onclick="window.__set(${it.rowId},'delivered')">Доставлен</button>
        </div>
      `;

      return `
        <div class="order-card">
          <div class="order-header">
            <div>
              <div class="order-status">${esc(statusLabel(it.status))}</div>
              <div class="order-id">ID: ${esc(it.rowId)}</div>
            </div>
            <div class="field-value muted" style="text-align: right;">${esc(fmtDate(it.ts))}</div>
          </div>
          
          <div class="order-field">
            <span class="field-label">Клиент</span>
            <span class="field-value">${esc(it.name||'—')}</span>
            <div class="field-value muted">${esc(it.phone||'—')}</div>
          </div>
          
          <div class="order-field">
            <span class="field-label">Товары</span>
            <span class="field-value muted">${esc(it.products||'—')}</span>
          </div>
          
          <div class="order-field">
            <span class="field-label">Адрес доставки</span>
            <span class="field-value muted">${esc(it.address||'—')}</span>
          </div>
          
          <div class="order-field">
            <span class="field-label">Сумма заказа</span>
            <span class="field-value">${esc(it.price||'—')}</span>
          </div>
          
          <div class="status-controls">
            <span class="field-label">Изменить статус</span>
            ${statusButtons}
            <div class="status-updated">Обновлено: ${esc(fmtDate(it.statusUpdated))}</div>
          </div>
        </div>
      `;
    }).join('');

    out.innerHTML = `
      <table class="desktop-table">
        <thead>
          <tr>
            <th>Статус</th>
            <th>Клиент</th>
            <th>Товары</th>
            <th>Адрес</th>
            <th>Сумма</th>
            <th>Управление</th>
          </tr>
        </thead>
        <tbody>${desktopRows}</tbody>
      </table>
      <div class="mobile-cards">${mobileCards}</div>
    `;
  }

  async function load(){
    out.innerHTML = '';
    msg.textContent = 'Загружаем…';
    try{
      const r = await jsonp({ action:'listRecent', token:ADMIN_TOKEN, days:String(days.value||1) });
      if(!r || !r.ok) throw new Error((r && r.error) || 'error');
      render(r.items || []);
      msg.textContent = 'Ок';
    }catch(e){
      msg.textContent = 'Ошибка: ' + (e.message || e);
    }
  }

  window.__set = setStatus;
  loadBtn.addEventListener('click', load);
  load();
}

document.addEventListener('DOMContentLoaded', () => {
  if (firebaseAuth) {
    firebaseAuth.onAuthStateChanged((user) => {
      if (user) {
        showAdminPanel(user);
      } else {
        showLoginScreen();
      }
    });
  }
  
  document.getElementById('login-button').addEventListener('click', () => {
    const email = document.getElementById('email-input').value;
    const password = document.getElementById('password-input').value;
    login(email, password);
  });
  
  document.getElementById('password-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      const email = document.getElementById('email-input').value;
      const password = document.getElementById('password-input').value;
      login(email, password);
    }
  });
  
  document.getElementById('logout-button').addEventListener('click', logout);
});
</script>
</body>
</html>
